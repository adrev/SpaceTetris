<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceTris</title>
    <!-- Google Fonts - Press Start 2P for retro 8-bit look -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Direct Firebase initialization - Fallback to config.js if needed -->
    <script>
    // Initialize Firebase directly to avoid initialization issues
    document.addEventListener('DOMContentLoaded', function() {
        try {
            console.log("Initializing Firebase...");
            
            // Check if Firebase is already initialized
            if (firebase.apps && firebase.apps.length > 0) {
                console.log("Firebase already initialized");
                return;
            }
            
            // Try to get config from the placeholder first (if config.js loaded it)
            const configPlaceholder = document.getElementById('firebase-config');
            let firebaseConfig;
            
            if (configPlaceholder && 
                configPlaceholder.getAttribute('data-api-key') && 
                configPlaceholder.getAttribute('data-database-url')) {
                // Use config from placeholder
                firebaseConfig = {
                    apiKey: configPlaceholder.getAttribute('data-api-key'),
                    authDomain: configPlaceholder.getAttribute('data-auth-domain'),
                    projectId: configPlaceholder.getAttribute('data-project-id'),
                    storageBucket: configPlaceholder.getAttribute('data-storage-bucket'),
                    messagingSenderId: configPlaceholder.getAttribute('data-messaging-sender-id'),
                    appId: configPlaceholder.getAttribute('data-app-id'),
                    databaseURL: configPlaceholder.getAttribute('data-database-url')
                };
                console.log("Using Firebase config from config.js");
            } else {
                // No config element found - provide instructions
                firebaseConfig = null;
                console.error("Firebase configuration not found. High scores will not be available.");
                window.safeLog("Firebase configuration not found. Make sure config.js is properly set up.", "error");
                
                // Show an error message to the user
                const errorMsg = document.createElement('div');
                errorMsg.style.position = 'fixed';
                errorMsg.style.top = '50%';
                errorMsg.style.left = '50%';
                errorMsg.style.transform = 'translate(-50%, -50%)';
                errorMsg.style.background = 'rgba(0,0,0,0.9)';
                errorMsg.style.color = '#ff0000';
                errorMsg.style.padding = '20px';
                errorMsg.style.border = '2px solid #ff0000';
                errorMsg.style.zIndex = '10000';
                errorMsg.innerHTML = `
                    <h3>Firebase Configuration Missing</h3>
                    <p>The game's high score system requires a Firebase configuration.</p>
                    <p>Please create a config.js file with your Firebase credentials.</p>
                    <button id="closeErrorMsg" style="background:#333; color:#fff; padding:5px 10px; margin-top:10px; cursor:pointer;">
                        Close
                    </button>
                `;
                document.body.appendChild(errorMsg);
                
                document.getElementById('closeErrorMsg').addEventListener('click', function() {
                    errorMsg.style.display = 'none';
                });
                
                return; // Exit initialization
            }
            
            // Log the database URL for debugging (without showing the full URL)
            if (firebaseConfig && firebaseConfig.databaseURL) {
                console.log("Database URL configured:", "***hidden***");
            }
            
            // Initialize Firebase
            if (firebaseConfig) {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized successfully");
                
                // Make Firebase functions globally accessible
                window.firebase = firebase;
                
                // Test database connection (read only, no write test)
                const connectedRef = firebase.database().ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    if (snap.val() === true) {
                        console.log("Connected to Firebase database");
                        
                        // Fetch highscores after connection is confirmed
                        setTimeout(() => {
                            getPublicHighscores();
                        }, 1000);
                    } else {
                        console.log("Not connected to Firebase database");
                    }
                });
            }
        } catch (error) {
            console.error("Error initializing Firebase:", error);
            window.safeLog("Firebase initialization error: " + error.message, "error");
        }
    });
    
    // Create a simplified error logging function
    window.safeLog = function(message, type) {
        // Log to console
        if (type === 'error') {
            console.error(message);
        } else if (type === 'warning') {
            console.warn(message);
        } else if (type === 'info') {
            console.info(message);
        } else {
            console.log(message);
        }
        
        // Create error log UI if it doesn't exist
        if (!document.getElementById('errorLogContainer')) {
            const container = document.createElement('div');
            container.id = 'errorLogContainer';
            container.style.position = 'fixed';
            container.style.top = '10px';
            container.style.right = '10px';
            container.style.zIndex = '10000';
            container.style.backgroundColor = '#000';
            container.style.border = '2px solid #ff0000';
            container.style.padding = '10px';
            container.style.maxHeight = '200px';
            container.style.overflowY = 'auto';
            container.style.fontFamily = 'monospace';
            container.style.fontSize = '12px';
            container.style.color = '#fff';
            document.body.appendChild(container);
        }
        
        // Add message to UI
        const container = document.getElementById('errorLogContainer');
        if (container) {
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '5px';
            messageElement.style.borderLeft = '3px solid';
            
            // Set color based on type
            let color;
            switch (type) {
                case 'error':
                    color = '#ff5555';
                    break;
                case 'warning':
                    color = '#ffaa00';
                    break;
                case 'info':
                    color = '#55aaff';
                    break;
                case 'success':
                    color = '#55ff55';
                    break;
                default:
                    color = '#ffffff';
            }
            
            messageElement.style.borderLeftColor = color;
            messageElement.style.paddingLeft = '5px';
            messageElement.textContent = `[${type}] ${message}`;
            container.appendChild(messageElement);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
    };
    </script>
    
    <!-- Firebase configuration placeholder - For backward compatibility -->
    <div id="firebase-config" 
         data-api-key="" 
         data-auth-domain="" 
         data-project-id="" 
         data-storage-bucket="" 
         data-messaging-sender-id="" 
         data-app-id="" 
         data-database-url=""
         style="display: none;">
    </div>
    
    <!-- Load Firebase configuration from external file -->
    <script src="config.js"></script>

    <style>
        /* Retro CRT scan lines effect */
        @keyframes scanlines {
            0% {
                background-position: 0 0;
            }
            100% {
                background-position: 0 20px;
            }
        }
        
        /* CRT flicker effect */
        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.9; }
            10% { opacity: 0.97; }
            15% { opacity: 1; }
            20% { opacity: 0.97; }
            25% { opacity: 0.9; }
            30% { opacity: 0.97; }
            35% { opacity: 1; }
            40% { opacity: 0.97; }
            45% { opacity: 0.95; }
            50% { opacity: 0.97; }
            55% { opacity: 1; }
            60% { opacity: 0.97; }
            65% { opacity: 0.9; }
            70% { opacity: 0.97; }
            75% { opacity: 1; }
            80% { opacity: 0.97; }
            85% { opacity: 0.9; }
            90% { opacity: 0.97; }
            95% { opacity: 1; }
            100% { opacity: 0.97; }
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Press Start 2P', cursive;
            background-color: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            line-height: 1.5;
            text-shadow: 2px 2px 0px #000;
            letter-spacing: 1px;
            animation: flicker 5s infinite;
            position: relative;
            overflow-x: hidden;
        }
        
        /* CRT scan lines overlay */
        body::after {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.15) 50%);
            background-size: 100% 4px;
            z-index: 10000;
            pointer-events: none;
            opacity: 0.3;
            animation: scanlines 0.5s linear infinite;
        }
        
        /* CRT edge effect */
        body::before {
            content: "";
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0.5) 90%, rgba(0,0,0,0.95) 100%);
            z-index: 9999;
            pointer-events: none;
        }
        
        #gameContainer {
            position: relative;
            margin: 0 auto;
            z-index: 1;
            width: 600px;
            height: 800px;
            box-sizing: content-box;
        }
        
        #gameCanvas {
            background-color: #000;
            display: block;
            image-rendering: pixelated; /* Makes canvas rendering pixelated */
            border: 4px solid #00ff00;
            box-shadow: 0 0 10px #00ff00, inset 0 0 10px #00ff00;
            width: 600px;
            height: 800px;
            position: relative;
            z-index: 2;
        }
        
        #gameOverOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none; /* Changed from flex to none to ensure it's hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            border: 4px solid #ff0000;
            box-shadow: 0 0 10px #ff0000, inset 0 0 10px #ff0000;
            pointer-events: auto;
        }
        
        #gameOverOverlay h2 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #ff5555;
            text-shadow: 2px 2px 0px #ff0000, 4px 4px 0px #000;
            letter-spacing: 2px;
        }
        
        #finalScore {
            font-size: 18px;
            margin-bottom: 20px;
            color: #ffff00;
        }
        
        #congratsMessage {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0px #ff8800, 4px 4px 0px #000;
        }
        
        #userProfile {
            width: 80%;
            max-width: 300px;
            border: 2px solid #00ffff;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        #settingsOverlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 350px;
            height: auto;
            background-color: rgba(0, 0, 0, 0.9);
            display: none; /* Changed from flex to none to ensure it's hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            z-index: 900;
            padding: 20px;
            box-sizing: border-box;
            border: 4px solid #ffff00;
            box-shadow: 0 0 10px #ffff00, inset 0 0 10px #ffff00;
            pointer-events: auto;
        }
        
        #settingsOverlay h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #ffff00;
            font-size: 20px;
            text-align: center;
            text-shadow: 2px 2px 0px #000;
        }
        
        .settingsGroup {
            width: 100%;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .settingsGroup label {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            font-size: 12px;
        }
        
        .settingsGroup input[type="checkbox"] {
            margin-left: 10px;
            width: 20px;
            height: 20px;
            appearance: none;
            background-color: #000;
            border: 2px solid #00ff00;
            position: relative;
            cursor: pointer;
        }
        
        .settingsGroup input[type="checkbox"]:checked::after {
            content: "";
            position: absolute;
            top: 2px;
            left: 2px;
            width: 12px;
            height: 12px;
            background-color: #00ff00;
        }
        
        #closeSettings {
                margin-top: 20px;
            padding: 10px 20px;
            background-color: #000;
            color: #ff0000;
            border: 2px solid #ff0000;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
        
        #closeSettings:hover {
            background-color: #ff0000;
            color: #000;
            box-shadow: 0 0 10px #ff0000;
        }
        
        #playerNameDisplay {
            margin-bottom: 15px;
            font-size: 14px;
            color: #00ffff;
        }
        
        .settingsButton {
            padding: 10px 15px;
            margin-top: 10px;
            background-color: #000;
            color: #00ffff;
            border: 2px solid #00ffff;
            cursor: pointer;
            font-size: 12px;
            width: 100%;
            transition: all 0.3s;
            font-family: 'Press Start 2P', cursive;
        }
        
        .settingsButton:hover {
            background-color: #00ffff;
            color: #000;
            box-shadow: 0 0 10px #00ffff;
        }
        
        #settingsBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #000;
            color: #ffff00;
            border: 2px solid #ffff00;
            font-size: 16px;
            cursor: pointer;
            z-index: 800;
            width: auto;
            height: auto;
            padding: 5px 10px;
            font-family: 'Press Start 2P', cursive;
        }
        
        #settingsBtn:hover {
            background-color: #ffff00;
            color: #000;
            box-shadow: 0 0 10px #ffff00;
        }
        
        #joystickContainer {
            position: absolute;
            bottom: 100px;
            left: 50px;
            width: 100px;
            height: 100px;
            z-index: 700;
        }
        
        #joystick {
            position: relative;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 10px #00ff00;
        }
        
        #joystickKnob {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            background-color: #00ff00;
            border-radius: 50%;
            box-shadow: 0 0 5px #00ff00;
        }
        
        #mobileFireBtn {
            position: absolute;
            bottom: 100px;
            right: 50px;
            width: 80px;
            height: 80px;
            background-color: #000;
            border: 2px solid #ff0000;
            border-radius: 50%;
            color: #ff0000;
            font-weight: bold;
            z-index: 700;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 5px #ff0000;
            box-shadow: 0 0 10px #ff0000;
        }
        
        #mobileFireBtn:active {
            background-color: #ff0000;
            color: #000;
        }
        
        #powerUpStatus {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 10px;
        }
        
        .powerUpIcon {
            width: 30px;
            height: 30px;
            border: 2px solid #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            opacity: 0.3;
            text-shadow: 0 0 5px #fff;
            box-shadow: 0 0 5px #fff;
        }
        
        .powerUpIcon.active {
            opacity: 1;
            box-shadow: 0 0 10px #fff, 0 0 20px #fff;
        }
        
        /* Game content */
        #gameContent {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Scoreboard and instructions */
        #sidebarContent {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 20px;
        }
        
        #instructions {
            flex: 1;
            max-width: 380px;
            text-align: center;
            border: 4px solid #00ffff;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px #00ffff;
            margin-right: 20px;
        }
        
        #instructions h2 {
            color: #00ffff;
            margin-top: 0;
            font-size: 18px;
            text-shadow: 2px 2px 0px #000;
        }
        
        #instructions ul {
            text-align: left;
            display: inline-block;
            padding-left: 20px;
            font-size: 12px;
        }
        
        #instructions li {
            margin-bottom: 10px;
        }
        
        #publicHighscoreDisplay {
            flex: 1;
            max-width: 380px;
            text-align: center;
            border: 4px solid #ffff00;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.8);
            box-shadow: 0 0 10px #ffff00;
            margin-left: 20px;
            overflow-y: auto;
            max-height: 400px;
        }
        
        #publicHighscoreDisplay h3 {
            color: #ffff00;
            margin-top: 0;
            font-size: 18px;
            text-shadow: 2px 2px 0px #000;
        }
        
        #publicHighscoreDisplay ol {
            text-align: left;
            display: inline-block;
            padding-left: 30px;
            font-size: 12px;
        }
        
        #publicHighscoreDisplay li {
            margin-bottom: 8px;
            color: #fff;
        }
        
        /* Submit score button styling */
        #submitScoreBtn {
            padding: 15px 20px;
            font-size: 14px;
            background-color: #000;
            color: #00ff00;
            border: 2px solid #00ff00;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
            transition: all 0.3s;
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
        }
        
        #submitScoreBtn:hover {
            background-color: #00ff00;
            color: #000;
            box-shadow: 0 0 10px #00ff00;
        }
        
        #submitScoreBtn:disabled {
            background-color: #444;
            color: #888;
            border-color: #888;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        /* Nickname input styling */
        #nicknameInput {
            margin-bottom: 10px;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid #00ffff;
            background-color: #000;
            color: #00ffff;
            font-size: 14px;
            font-family: 'Press Start 2P', cursive;
        }
        
        #nicknameInput:focus {
            outline: none;
            box-shadow: 0 0 10px #00ffff;
        }
        
        /* Countdown styling */
        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 20px #00ffff, 0 0 40px #00ffff;
            z-index: 2000;
            font-family: 'Press Start 2P', cursive;
        }
        
        /* Status message styling */
        #submitStatusMessage {
            padding: 10px;
            border: 1px solid #00ff00;
            background-color: rgba(0, 0, 0, 0.8);
            margin-bottom: 10px;
            font-size: 12px;
            line-height: 1.3;
        }
    </style>
</head>
<body>
    <div id="gameContent">
        <div id="gameContainer" style="position: relative; margin: 0 auto; width: 600px; height: 800px;">
            <canvas id="gameCanvas" width="600" height="800" style="display: block; background-color: #000033; border: 4px solid #00ff00;"></canvas>
            <div id="gameOverOverlay" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 1000; text-align: center; padding: 20px; box-sizing: border-box;">
                <h2 style="color: #ff5555; font-family: 'Press Start 2P', cursive; font-size: 24px; margin-bottom: 20px; text-shadow: 2px 2px 0px #ff0000, 4px 4px 0px #000; letter-spacing: 2px;">GAME OVER</h2>
                <p id="finalScore" style="color: #ffff00; font-family: 'Press Start 2P', cursive; font-size: 18px; margin-bottom: 20px;">SCORE: 0</p>
                <p id="congratsMessage" style="color: #ffff00; font-family: 'Press Start 2P', cursive; font-weight: bold; margin-bottom: 20px; text-shadow: 2px 2px 0px #ff8800, 4px 4px 0px #000;"></p>
                <div id="userProfile" style="width: 80%; max-width: 300px; border: 2px solid #00ffff; padding: 20px; background-color: rgba(0, 0, 0, 0.9); margin: 0 auto;"></div>
            </div>
            <div id="settingsOverlay" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 350px; height: auto; background-color: rgba(0, 0, 0, 0.9); z-index: 900; padding: 20px; box-sizing: border-box; border: 4px solid #ffff00; box-shadow: 0 0 10px #ffff00;">
                <h2 style="color: #ffff00; font-family: 'Press Start 2P', cursive; font-size: 20px; text-align: center; text-shadow: 2px 2px 0px #000; margin-top: 0; margin-bottom: 20px;">SETTINGS</h2>
                <p id="playerNameDisplay" style="color: #00ffff; font-family: 'Press Start 2P', cursive; font-size: 14px; margin-bottom: 15px;">PLAYER: ANONYMOUS</p>
                <div style="margin-bottom: 10px;">
                    <label for="soundToggle" style="font-family: 'Press Start 2P', cursive; font-size: 12px; display: flex; align-items: center; justify-content: space-between; width: 100%;">SOUND:
                        <input type="checkbox" id="soundToggle" checked style="width: 20px; height: 20px; margin-left: 10px;">
                    </label>
                </div>
                <div style="margin-bottom: 15px;">
                    <label for="musicToggle" style="font-family: 'Press Start 2P', cursive; font-size: 12px; display: flex; align-items: center; justify-content: space-between; width: 100%;">MUSIC:
                        <input type="checkbox" id="musicToggle" checked style="width: 20px; height: 20px; margin-left: 10px;">
                    </label>
                </div>
                <button id="closeSettings" style="margin-top: 20px; padding: 10px 20px; background-color: #000; color: #ff0000; border: 2px solid #ff0000; cursor: pointer; font-size: 14px; font-family: 'Press Start 2P', cursive; display: block; width: 100%;">CLOSE</button>
            </div>
            <button id="settingsBtn" style="position: absolute; top: 10px; right: 10px; background: #000; color: #ffff00; border: 2px solid #ffff00; font-size: 16px; cursor: pointer; z-index: 800; padding: 5px 10px; font-family: 'Press Start 2P', cursive;">⚙️</button>
            <div id="powerUpStatus" style="position: absolute; top: 10px; left: 10px; display: flex; gap: 10px; z-index: 700;"></div>
        </div>
        
        <div id="sidebarContent" style="display: flex; justify-content: space-between; width: 100%; margin-top: 20px; max-width: 1200px;">
            <div id="instructions" style="flex: 1; max-width: 380px; text-align: center; border: 4px solid #00ffff; padding: 15px; background-color: rgba(0, 0, 0, 0.8); box-shadow: 0 0 10px #00ffff; margin-right: 20px;">
                <h2 style="color: #00ffff; font-family: 'Press Start 2P', cursive; margin-top: 0; font-size: 18px; text-shadow: 2px 2px 0px #000;">HOW TO PLAY</h2>
                <ul style="text-align: left; display: inline-block; padding-left: 20px; font-size: 12px; font-family: 'Press Start 2P', cursive; line-height: 1.5;">
                    <li style="margin-bottom: 10px;"><strong>MOVE:</strong> Use arrow keys or on-screen joystick.</li>
                    <li style="margin-bottom: 10px;"><strong>SHOOT:</strong> Press spacebar or the fire button.</li>
                    <li style="margin-bottom: 10px;"><strong>AVOID:</strong> Don't let invaders or blocks hit your ship or reach the bottom.</li>
                    <li style="margin-bottom: 10px;"><strong>POWER-UPS:</strong> Collect colored orbs for special abilities: <em>Shield (S)</em>, <em>Spread Shot (B)</em>, and <em>Slow Motion (T)</em>.</li>
        </ul>
    </div>

            <div id="publicHighscoreDisplay" style="flex: 1; max-width: 380px; text-align: center; border: 4px solid #ffff00; padding: 15px; background-color: rgba(0, 0, 0, 0.8); box-shadow: 0 0 10px #ffff00; margin-left: 20px; overflow-y: auto; max-height: 400px;">
                <h3 style="color: #ffff00; font-family: 'Press Start 2P', cursive; margin-top: 0; font-size: 18px; text-shadow: 2px 2px 0px #000;">TOP SCORES</h3>
                <div id="publicHighscoresList" style="width: 100%; margin-top: 15px;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #ffff00; padding-bottom: 5px; margin-bottom: 10px;">
                        <span style="width: 20%; text-align: center; font-weight: bold; color: #ffff00;">RANK</span>
                        <span style="width: 50%; text-align: left; font-weight: bold; color: #ffff00;">NAME</span>
                        <span style="width: 30%; text-align: right; font-weight: bold; color: #ffff00;">SCORE</span>
                    </div>
                    <div id="loadingScores" style="text-align: center; padding: 20px 0;">
                        Loading highscores...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error logging system - Simplified to avoid syntax errors -->
    <script>
    // Create a simplified error logging function
    window.safeLog = function(message, type) {
        // Log to console
        if (type === 'error') {
            console.error(message);
        } else if (type === 'warning') {
            console.warn(message);
        } else if (type === 'info') {
            console.info(message);
        } else {
            console.log(message);
        }
        
        // Create error log UI if it doesn't exist
        if (!document.getElementById('errorLogContainer')) {
            const container = document.createElement('div');
            container.id = 'errorLogContainer';
            container.style.position = 'fixed';
            container.style.top = '10px';
            container.style.right = '10px';
            container.style.zIndex = '10000';
            container.style.backgroundColor = '#000';
            container.style.border = '2px solid #ff0000';
            container.style.padding = '10px';
            container.style.maxHeight = '200px';
            container.style.overflowY = 'auto';
            container.style.fontFamily = 'monospace';
            container.style.fontSize = '12px';
            container.style.color = '#fff';
            document.body.appendChild(container);
        }
        
        // Add message to UI
        const container = document.getElementById('errorLogContainer');
        if (container) {
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '5px';
            messageElement.style.borderLeft = '3px solid';
            
            // Set color based on type
            let color;
            switch (type) {
                case 'error':
                    color = '#ff5555';
                    break;
                case 'warning':
                    color = '#ffaa00';
                    break;
                case 'info':
                    color = '#55aaff';
                    break;
                case 'success':
                    color = '#55ff55';
                    break;
                default:
                    color = '#ffffff';
            }
            
            messageElement.style.borderLeftColor = color;
            messageElement.style.paddingLeft = '5px';
            messageElement.textContent = `[${type}] ${message}`;
            container.appendChild(messageElement);
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
    };
    </script>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');

        // Game constants
        const GRID_SIZE = 20;
        const PLAYER_SPEED = 5;
        const BULLET_SPEED = 8;
        const ENEMY_SPEED = 1;
        
        // Game state
        let score = 0;
        let highScore = localStorage.getItem('highScore') || 0;
        let gameOver = false;
        let animationId;

        // Game objects
        let player = {
            x: canvas.width / 2 - 20,
            y: canvas.height - 40,
            width: 40,
            height: 20,
            speed: PLAYER_SPEED
        };
        
        let bullets = [];
        let enemies = [];
        let lastEnemySpawn = 0;
        
        // Controls
        let keys = {
            left: false,
            right: false,
            space: false
        };
        
        // Audio system
        let audioContext;
        let backgroundMusic;
        let soundEffects = {};
        let isMuted = false;
        
        // Explosions array
        let explosions = [];
        
        // Initialize audio system
        function initializeAudio() {
            try {
                window.safeLog("Initializing audio system...", "info");
                
                // Create audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Load background music
                loadBackgroundMusic();
                
                // Load sound effects
                loadSoundEffects();
                
                // Check if previously muted
                const savedMuteState = localStorage.getItem('isMuted');
                if (savedMuteState === 'true') {
                    isMuted = true;
                    window.safeLog("Audio initialized in muted state (from saved preference)", "info");
                } else {
                    window.safeLog("Audio initialized successfully", "success");
                }
                
                // Add mute toggle button
                addMuteButton();
            } catch (error) {
                window.safeLog("Error initializing audio: " + error.message, "error");
            }
        }
        
        // Load background music
        function loadBackgroundMusic() {
            try {
                window.safeLog("Loading background music from local files...", "info");
                
                // Define the soundtrack playlist
                const soundtrack = [
                    "SpaceTris_Soundtrack/01 - Main Theme - Galactic Inferno.mp3",
                    "SpaceTris_Soundtrack/02 - Cosmic Cascade.mp3",
                    "SpaceTris_Soundtrack/03 - Pixel Invasion.mp3",
                    "SpaceTris_Soundtrack/04 - Neon Blocks.mp3",
                    "SpaceTris_Soundtrack/05 - Galactic Grid.mp3",
                    "SpaceTris_Soundtrack/06 - Retro Orbit.mp3",
                    "SpaceTris_Soundtrack/07 - Tetrimino Twilight.mp3",
                    "SpaceTris_Soundtrack/08 - Alien Ascension.mp3",
                    "SpaceTris_Soundtrack/09 - Arcade Anomaly.mp3",
                    "SpaceTris_Soundtrack/10 - Synth Spacefall.mp3",
                    "SpaceTris_Soundtrack/11 - Digital Drift.mp3"
                ];
                
                // Track the current song index
                let currentSongIndex = 0;
                
                // Create audio element for background music
                backgroundMusic = new Audio(soundtrack[currentSongIndex]);
                backgroundMusic.volume = 0.3;
                
                // Add error handler
                backgroundMusic.onerror = function(e) {
                    window.safeLog(`Error loading background music: ${soundtrack[currentSongIndex]}`, "error");
                    console.error("Audio error:", e);
                    
                    // Try the next song
                    currentSongIndex = (currentSongIndex + 1) % soundtrack.length;
                    backgroundMusic.src = soundtrack[currentSongIndex];
                };
                
                // Add loaded handler
                backgroundMusic.oncanplaythrough = function() {
                    window.safeLog(`Background music loaded: ${soundtrack[currentSongIndex]}`, "success");
                };
                
                // Add ended handler to play the next song
                backgroundMusic.onended = function() {
                    // Move to the next song
                    currentSongIndex = (currentSongIndex + 1) % soundtrack.length;
                    backgroundMusic.src = soundtrack[currentSongIndex];
                    
                    // Play the next song
                    backgroundMusic.play().catch(error => {
                        window.safeLog(`Error playing next song: ${error.message}`, "error");
                    });
                };
                
                // Expose the playlist functionality
                window.nextSong = function() {
                    if (isMuted) return;
                    
                    currentSongIndex = (currentSongIndex + 1) % soundtrack.length;
                    backgroundMusic.src = soundtrack[currentSongIndex];
                    backgroundMusic.play().catch(error => {
                        window.safeLog(`Error playing next song: ${error.message}`, "error");
                    });
                    
                    window.safeLog(`Playing next song: ${soundtrack[currentSongIndex]}`, "info");
                };
                
                window.previousSong = function() {
                    if (isMuted) return;
                    
                    currentSongIndex = (currentSongIndex - 1 + soundtrack.length) % soundtrack.length;
                    backgroundMusic.src = soundtrack[currentSongIndex];
                    backgroundMusic.play().catch(error => {
                        window.safeLog(`Error playing previous song: ${error.message}`, "error");
                    });
                    
                    window.safeLog(`Playing previous song: ${soundtrack[currentSongIndex]}`, "info");
                };
                
                // Add music controls to the settings panel
                addMusicControls();
            } catch (error) {
                window.safeLog("Error loading background music: " + error.message, "error");
            }
        }
        
        // Add music controls to the settings panel
        function addMusicControls() {
            try {
                // Wait for the settings panel to be available
                const checkSettingsInterval = setInterval(() => {
                    const settingsPanel = document.getElementById('settingsOverlay');
                    if (!settingsPanel) return;
                    
                    clearInterval(checkSettingsInterval);
                    
                    // Get the music toggle element
                    const musicToggle = document.getElementById('musicToggle');
                    if (musicToggle) {
                        // Set initial state
                        musicToggle.checked = !isMuted;
                        
                        // Add change handler
                        musicToggle.addEventListener('change', function() {
                            toggleMute();
                        });
                    }
                    
                    // Add music control buttons
                    const musicControlsDiv = document.createElement('div');
                    musicControlsDiv.style.marginBottom = '15px';
                    musicControlsDiv.style.display = 'flex';
                    musicControlsDiv.style.justifyContent = 'space-between';
                    musicControlsDiv.style.alignItems = 'center';
                    
                    // Add label
                    const musicLabel = document.createElement('span');
                    musicLabel.style.fontFamily = "'Press Start 2P', cursive";
                    musicLabel.style.fontSize = '12px';
                    musicLabel.textContent = 'TRACK:';
                    
                    // Add controls
                    const controlsWrapper = document.createElement('div');
                    controlsWrapper.style.display = 'flex';
                    controlsWrapper.style.gap = '10px';
                    
                    // Previous button
                    const prevButton = document.createElement('button');
                    prevButton.textContent = '◀';
                    prevButton.style.backgroundColor = '#000';
                    prevButton.style.color = '#00ffff';
                    prevButton.style.border = '2px solid #00ffff';
                    prevButton.style.padding = '5px 10px';
                    prevButton.style.cursor = 'pointer';
                    prevButton.style.fontFamily = "'Press Start 2P', cursive";
                    prevButton.style.fontSize = '12px';
                    prevButton.onclick = window.previousSong;
                    
                    // Next button
                    const nextButton = document.createElement('button');
                    nextButton.textContent = '▶';
                    nextButton.style.backgroundColor = '#000';
                    nextButton.style.color = '#00ffff';
                    nextButton.style.border = '2px solid #00ffff';
                    nextButton.style.padding = '5px 10px';
                    nextButton.style.cursor = 'pointer';
                    nextButton.style.fontFamily = "'Press Start 2P', cursive";
                    nextButton.style.fontSize = '12px';
                    nextButton.onclick = window.nextSong;
                    
                    // Add buttons to controls wrapper
                    controlsWrapper.appendChild(prevButton);
                    controlsWrapper.appendChild(nextButton);
                    
                    // Add elements to music controls div
                    musicControlsDiv.appendChild(musicLabel);
                    musicControlsDiv.appendChild(controlsWrapper);
                    
                    // Find where to insert the music controls
                    const closeButton = document.getElementById('closeSettings');
                    if (closeButton && closeButton.parentNode) {
                        closeButton.parentNode.insertBefore(musicControlsDiv, closeButton);
                    }
                }, 100);
            } catch (error) {
                window.safeLog("Error adding music controls: " + error.message, "error");
            }
        }
        
        // Load sound effects
        function loadSoundEffects() {
            try {
                // Define sound effects to load
                const effectsToLoad = {
                    shoot: 'sounds/laser.mp3',
                    explosion: 'sounds/explosion.mp3',
                    gameOver: 'sounds/gameover.mp3',
                    powerUp: 'sounds/powerup.mp3'
                };
                
                // Fallback URLs if local files aren't available
                const fallbackUrls = {
                    shoot: 'https://www.soundjay.com/mechanical/sounds/laser-gun-19.mp3',
                    explosion: 'https://www.soundjay.com/mechanical/sounds/explosion-01.mp3',
                    gameOver: 'https://www.soundjay.com/human/sounds/man-scream-02.mp3',
                    powerUp: 'https://www.soundjay.com/button/sounds/button-09.mp3'
                };
                
                // Load each sound effect
                for (const [name, url] of Object.entries(effectsToLoad)) {
                    const audio = new Audio(url);
                    
                    // Add error handler with fallback
                    audio.onerror = function() {
                        window.safeLog(`Error loading sound effect: ${name} from ${url}, trying fallback`, "warning");
                        
                        // Try fallback URL
                        audio.src = fallbackUrls[name];
                        
                        // Add error handler for fallback
                        audio.onerror = function() {
                            window.safeLog(`Error loading fallback sound effect: ${name}`, "error");
                        };
                    };
                    
                    // Add loaded handler
                    audio.oncanplaythrough = function() {
                        window.safeLog(`Sound effect loaded: ${name}`, "success");
                    };
                    
                    soundEffects[name] = audio;
                }
                
                // Set up sound toggle in settings
                setupSoundToggle();
            } catch (error) {
                window.safeLog("Error loading sound effects: " + error.message, "error");
            }
        }
        
        // Setup sound toggle in settings
        function setupSoundToggle() {
            try {
                // Wait for the settings panel to be available
                const checkSettingsInterval = setInterval(() => {
                    const soundToggle = document.getElementById('soundToggle');
                    if (!soundToggle) return;
                    
                    clearInterval(checkSettingsInterval);
                    
                    // Set initial state
                    soundToggle.checked = !isMuted;
                    
                    // Add change handler
                    soundToggle.addEventListener('change', function() {
                        toggleSoundEffects();
                    });
                }, 100);
            } catch (error) {
                window.safeLog("Error setting up sound toggle: " + error.message, "error");
            }
        }
        
        // Toggle sound effects only
        function toggleSoundEffects() {
            try {
                const soundToggle = document.getElementById('soundToggle');
                const soundEffectsEnabled = soundToggle ? soundToggle.checked : !isMuted;
                
                // Update the sound effects state
                for (const sound of Object.values(soundEffects)) {
                    sound.muted = !soundEffectsEnabled;
                }
                
                window.safeLog(`Sound effects ${soundEffectsEnabled ? 'enabled' : 'disabled'}`, "info");
            } catch (error) {
                window.safeLog("Error toggling sound effects: " + error.message, "error");
            }
        }
        
        // Toggle music only
        function toggleMusic() {
            try {
                const musicToggle = document.getElementById('musicToggle');
                const musicEnabled = musicToggle ? musicToggle.checked : !isMuted;
                
                // Update the music state
                if (backgroundMusic) {
                    if (musicEnabled) {
                        playBackgroundMusic();
                    } else {
                        backgroundMusic.pause();
                    }
                }
                
                window.safeLog(`Music ${musicEnabled ? 'enabled' : 'disabled'}`, "info");
            } catch (error) {
                window.safeLog("Error toggling music: " + error.message, "error");
            }
        }
        
        // Toggle mute state (both music and sound effects)
        function toggleMute() {
            try {
                isMuted = !isMuted;
                
                // Save mute preference
                localStorage.setItem('isMuted', isMuted);
                
                // Update mute button
                const muteButton = document.getElementById('muteButton');
                if (muteButton) {
                    muteButton.textContent = isMuted ? '🔇' : '🔊';
                    muteButton.title = isMuted ? 'Unmute' : 'Mute';
                }
                
                // Update settings toggles
                const soundToggle = document.getElementById('soundToggle');
                if (soundToggle) {
                    soundToggle.checked = !isMuted;
                }
                
                const musicToggle = document.getElementById('musicToggle');
                if (musicToggle) {
                    musicToggle.checked = !isMuted;
                }
                
                // Handle background music
                if (isMuted) {
                    if (backgroundMusic && !backgroundMusic.paused) {
                        backgroundMusic.pause();
                    }
                } else {
                    playBackgroundMusic();
                }
                
                // Handle sound effects
                for (const sound of Object.values(soundEffects)) {
                    sound.muted = isMuted;
                }
                
                window.safeLog(`All sound ${isMuted ? 'muted' : 'unmuted'}`, "info");
            } catch (error) {
                window.safeLog("Error toggling mute: " + error.message, "error");
            }
        }
        
        // Play background music
        function playBackgroundMusic() {
            try {
                if (isMuted || !backgroundMusic) return;
                
                // Check if already playing
                if (!backgroundMusic.paused) return;
                
                // Play with error handling
                backgroundMusic.play().catch(error => {
                    if (error.name === 'NotAllowedError') {
                        window.safeLog("Background music autoplay blocked. Will try again on user interaction.", "warning");
                        
                        // Add one-time click handler to start music
                        const startAudioOnInteraction = function() {
                            backgroundMusic.play().catch(e => {
                                window.safeLog("Still couldn't play background music: " + e.message, "error");
                            });
                            document.removeEventListener('click', startAudioOnInteraction);
                            document.removeEventListener('keydown', startAudioOnInteraction);
                        };
                        
                        document.addEventListener('click', startAudioOnInteraction);
                        document.addEventListener('keydown', startAudioOnInteraction);
                    } else {
                        window.safeLog("Error playing background music: " + error.message, "error");
                    }
                });
            } catch (error) {
                window.safeLog("Error in playBackgroundMusic: " + error.message, "error");
            }
        }
        
        // Play sound effect
        function playSoundEffect(name) {
            try {
                if (isMuted || !soundEffects[name]) return;
                
                // Clone the audio to allow overlapping sounds
                const sound = soundEffects[name].cloneNode();
                
                // Play with error handling
                sound.play().catch(error => {
                    window.safeLog(`Error playing sound effect ${name}: ${error.message}`, "error");
                });
            } catch (error) {
                window.safeLog(`Error in playSoundEffect (${name}): ${error.message}`, "error");
            }
        }
        
        // Add mute button to the UI
        function addMuteButton() {
            try {
                // Check if button already exists
                if (document.getElementById('muteButton')) return;
                
                // Create button
                const muteButton = document.createElement('button');
                muteButton.id = 'muteButton';
                muteButton.textContent = isMuted ? '🔇' : '🔊';
                muteButton.title = isMuted ? 'Unmute' : 'Mute';
                
                // Style the button
                muteButton.style.position = 'absolute';
                muteButton.style.top = '10px';
                muteButton.style.left = '10px';
                muteButton.style.zIndex = '1000';
                muteButton.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                muteButton.style.color = '#00ff00';
                muteButton.style.border = '2px solid #00ff00';
                muteButton.style.borderRadius = '5px';
                muteButton.style.padding = '5px 10px';
                muteButton.style.fontSize = '20px';
                muteButton.style.cursor = 'pointer';
                muteButton.style.boxShadow = '0 0 5px #00ff00';
                
                // Add hover effect
                muteButton.onmouseover = function() {
                    this.style.backgroundColor = 'rgba(0, 255, 0, 0.2)';
                };
                muteButton.onmouseout = function() {
                    this.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                };
                
                // Add click handler
                muteButton.onclick = toggleMute;
                
                // Add to document
                document.body.appendChild(muteButton);
            } catch (error) {
                window.safeLog("Error adding mute button: " + error.message, "error");
            }
        }
        
        // Call audio initialization after the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize audio system
            initializeAudio();
            
            // Start background music on first interaction
            const startAudioOnFirstInteraction = function() {
                playBackgroundMusic();
                document.removeEventListener('click', startAudioOnFirstInteraction);
                document.removeEventListener('keydown', startAudioOnFirstInteraction);
            };
            
            document.addEventListener('click', startAudioOnFirstInteraction);
            document.addEventListener('keydown', startAudioOnFirstInteraction);
        });
        
        // Function to sanitize input to prevent XSS
        function sanitize(text) {
            // Create a temporary div element
            const tempDiv = document.createElement('div');
            // Set its text content to the input text
            tempDiv.textContent = text;
            // Return the HTML-escaped string
            return tempDiv.innerHTML;
        }
        
        // Initialize game
        function init() {
            console.log("Initializing game...");
            
            // Reset game state
            score = 0;
            gameOver = false;
            bullets = [];
            enemies = [];
            lastEnemySpawn = 0;
            
            // Reset player position
            player.x = canvas.width / 2 - 20;
            player.y = canvas.height - 40;
            
            // Update displays
            updateScoreDisplay();
            
            // Hide game over screen
            const gameOverScreen = document.getElementById('gameOverOverlay');
            if (gameOverScreen) {
                gameOverScreen.style.display = 'none';
            }
            
            // Start game loop
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            gameLoop();
            
            console.log("Game initialized successfully");
        }
        
        // Game loop
        function gameLoop() {
            if (!gameOver) {
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Update game objects
                updatePlayer();
                updateBullets();
                updateEnemies();
                updateExplosions();
                checkCollisions();
                
                // Draw game objects
                drawBackground();
                drawPlayer();
                drawBullets();
                drawEnemies();
                drawExplosions();
                drawScore();
                
                // Continue the game loop
                requestAnimationFrame(gameLoop);
            }
        }
        
        // Start the game
        function startGame() {
            // Reset game state
            resetGame();
            
            // Start background music
            playBackgroundMusic();
            
            // Start game loop
            gameLoop();
        }
        
        // Initialize the game when the page loads
        window.addEventListener('load', function() {
            // Initialize canvas
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            canvas.width = 600;
            canvas.height = 400;
            
            // Start the game
            startGame();
        });
        
        // Update game state
        function update() {
            // Move player
            if (keys.left && player.x > 0) {
                player.x -= player.speed;
            }
            if (keys.right && player.x < canvas.width - player.width) {
                player.x += player.speed;
            }
            
            // Shoot bullets
            if (keys.space) {
                // Limit firing rate
                if (bullets.length === 0 || bullets[bullets.length - 1].y < canvas.height - 100) {
                    bullets.push({
                        x: player.x + player.width / 2 - 2,
                        y: player.y - 10,
                        width: 4,
                        height: 10,
                        speed: BULLET_SPEED
                    });
                }
            }
            
            // Move bullets
            for (let i = bullets.length - 1; i >= 0; i--) {
                bullets[i].y -= bullets[i].speed;
                
                // Remove bullets that go off screen
                if (bullets[i].y + bullets[i].height < 0) {
                    bullets.splice(i, 1);
                }
            }
            
            // Spawn enemies
            if (Date.now() - lastEnemySpawn > 1000) {
                const enemyWidth = 30;
                const enemyHeight = 30;
                const x = Math.random() * (canvas.width - enemyWidth);
                
                enemies.push({
                    x: x,
                    y: -enemyHeight,
                    width: enemyWidth,
                    height: enemyHeight,
                    speed: ENEMY_SPEED + Math.random() * 2
                });
                
                lastEnemySpawn = Date.now();
            }
            
            // Move enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                enemies[i].y += enemies[i].speed;
                
                // Check if enemy reached bottom
                if (enemies[i].y > canvas.height) {
                    gameOver = true;
                    showGameOver();
                    return;
                }
                
                // Check collision with player
                if (checkCollision(player, enemies[i])) {
                    gameOver = true;
                    showGameOver();
                    return;
                }
                
                // Check collision with bullets
                for (let j = bullets.length - 1; j >= 0; j--) {
                    if (checkCollision(bullets[j], enemies[i])) {
                        // Remove enemy and bullet
                        enemies.splice(i, 1);
                        bullets.splice(j, 1);
                        
                        // Increase score
                        score += 10;
                        updateScoreDisplay();
                        
                        // Play explosion sound
                        playSoundEffect('explosion');
                        
                        // Add explosion effect
                        addExplosion(enemies[i].x + enemies[i].width / 2, enemies[i].y + enemies[i].height / 2);
                        
                        break;
                    }
                }
            }
        }
        
        // Draw game objects
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw grid
            ctx.strokeStyle = '#111';
            ctx.lineWidth = 1;
            
            // Draw vertical grid lines
            for (let x = 0; x < canvas.width; x += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            // Draw horizontal grid lines
            for (let y = 0; y < canvas.height; y += GRID_SIZE) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // Draw player
            ctx.fillStyle = '#00ff00';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#00ff00';
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Draw player cockpit
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(player.x + player.width / 4, player.y - player.height / 2, player.width / 2, player.height / 2);
            
            // Reset shadow
            ctx.shadowBlur = 0;
            
            // Draw bullets
            ctx.fillStyle = '#00ffff';
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#00ffff';
            
            for (const bullet of bullets) {
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
            }
            
            // Reset shadow
            ctx.shadowBlur = 0;
            
            // Draw enemies
            ctx.fillStyle = '#ff0000';
            ctx.shadowBlur = 10;
            ctx.shadowColor = '#ff0000';
            
            for (const enemy of enemies) {
                // Draw enemy body
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                
                // Draw enemy eyes
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(enemy.x + 5, enemy.y + 5, 5, 5);
                ctx.fillRect(enemy.x + enemy.width - 10, enemy.y + 5, 5, 5);
                
                // Reset fill style
                ctx.fillStyle = '#ff0000';
            }
            
            // Reset shadow
            ctx.shadowBlur = 0;
            
            // Draw score
            ctx.fillStyle = '#00ffff';
            ctx.font = '16px "Press Start 2P"';
            ctx.textAlign = 'left';
            ctx.shadowBlur = 5;
            ctx.shadowColor = '#00ffff';
            ctx.fillText(`SCORE: ${score}`, 10, 30);
            
            ctx.textAlign = 'right';
            ctx.fillText(`HI-SCORE: ${highScore}`, canvas.width - 10, 30);
            
            // Reset shadow
            ctx.shadowBlur = 0;
        }
        
        // Check collision between two objects
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }
        
        // Update score display
        function updateScoreDisplay() {
            // Update high score if needed
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
            }
            
            // Update game over screen if it exists
            const finalScore = document.getElementById('finalScore');
            if (finalScore) {
                finalScore.textContent = `SCORE: ${score}`;
            }
        }
        
        // Show game over screen
        function showGameOver() {
            const gameOverScreen = document.getElementById('gameOverOverlay');
            if (gameOverScreen) {
                const finalScore = document.getElementById('finalScore');
                if (finalScore) {
                    finalScore.textContent = `SCORE: ${score}`;
                }
                gameOverScreen.style.display = 'flex';
                
                // Attach submit score listener
                attachSubmitScoreListener();
            }
        }
        
        // Function to attach submit score listener
        function attachSubmitScoreListener() {
            try {
                console.log("Attaching submit score listener");
                const userProfile = document.getElementById('userProfile');
                if (!userProfile) {
                    console.error("User profile element not found");
                return;
            }

                // Clear existing content
                userProfile.innerHTML = '';
                
                // Create message
                const message = document.createElement('p');
                message.textContent = 'ENTER YOUR NAME:';
                userProfile.appendChild(message);
                
                // Create input for nickname
                const nicknameInput = document.createElement('input');
                nicknameInput.type = 'text';
                nicknameInput.id = 'nicknameInput';
                nicknameInput.maxLength = 30;
                nicknameInput.placeholder = 'YOUR NAME';
                nicknameInput.style.marginBottom = '10px';
                nicknameInput.style.padding = '5px';
                nicknameInput.style.width = '100%';
                
                // Pre-populate with stored name if available
                const storedName = localStorage.getItem("playerName");
                if (storedName) {
                    nicknameInput.value = storedName;
                }
                
                userProfile.appendChild(nicknameInput);
                
                // Create status message element
                const statusMessage = document.createElement('div');
                statusMessage.id = 'submitStatusMessage';
                statusMessage.style.color = '#00ff00';
                statusMessage.style.marginBottom = '10px';
                statusMessage.style.fontWeight = 'bold';
                statusMessage.style.display = 'none';
                userProfile.appendChild(statusMessage);
                
                // Create submit button
                const submitButton = document.createElement('button');
                submitButton.textContent = 'SUBMIT SCORE';
                submitButton.id = 'submitScoreBtn';
                
                // Add click event using onclick property
                submitButton.onclick = function() {
                    window.safeLog("Submit button clicked", "info");
                    
                    // Disable button to prevent multiple submissions
                    this.disabled = true;
                    this.textContent = 'SUBMITTING...';
                    
                    // Show status message
                    statusMessage.textContent = 'SUBMITTING SCORE...';
                    statusMessage.style.display = 'block';
                    
                    // Get the nickname
                    const name = nicknameInput.value.trim() || "Anonymous";
                    window.safeLog(`Submitting score for: ${name}, Score: ${score}`, "info");
                    
                    try {
                        // Save name to localStorage
                        localStorage.setItem("playerName", name);
                        
                        // Local sanitize function in case the global one is not defined
                        const sanitizeName = function(text) {
                            const tempDiv = document.createElement('div');
                            tempDiv.textContent = text;
                            return tempDiv.innerHTML;
                        };
                        
                        // Use either the global sanitize function or the local one
                        const sanitizedName = typeof sanitize === 'function' ? sanitize(name) : sanitizeName(name);
                        
                        // Try to submit to Firebase if available
                        if (window.firebase && window.firebase.database) {
                            const highscoresRef = firebase.database().ref('highscores');
                            
                            // Create the score object
                            const highscoreObj = { 
                                name: sanitizedName, 
                                score: Number(score), 
                                timestamp: Date.now() 
                            };
                            
                            highscoresRef.push(highscoreObj)
                                .then(() => {
                                    window.safeLog("Score successfully submitted to database!", "success");
                                    statusMessage.textContent = 'SCORE SUBMITTED!';
                                    statusMessage.style.color = '#00ff00';
                                    
                                    // Start countdown after successful submission
                                    setTimeout(() => {
                                        doCountdownAndRestart();
                                    }, 1000);
                                })
                                .catch((error) => {
                                    // Check if it's a permission error
                                    if (error.message && error.message.includes("PERMISSION_DENIED")) {
                                        window.safeLog("Permission denied when submitting score. This is expected in read-only mode.", "warning");
                                        statusMessage.textContent = 'SCORE SAVED LOCALLY';
                                        statusMessage.style.color = '#ffff00';
                                    } else {
                                        window.safeLog(`Firebase error writing score: ${error.message}`, "error");
                                        statusMessage.textContent = 'ERROR SUBMITTING SCORE';
                                        statusMessage.style.color = '#ff0000';
                                    }
                                    
                                    // Start countdown anyway
                                    setTimeout(() => {
                                        doCountdownAndRestart();
                                    }, 1000);
                                });
                        } else {
                            // No Firebase, just save locally
                            window.safeLog("Firebase not available, saving score locally only", "warning");
                            statusMessage.textContent = 'SCORE SAVED LOCALLY';
                            statusMessage.style.color = '#ffff00';
                            
                            // Start countdown
                            setTimeout(() => {
                                doCountdownAndRestart();
                            }, 1000);
                        }
                    } catch (error) {
                        window.safeLog(`Error in submit button handler: ${error.message}`, "error");
                        statusMessage.textContent = 'ERROR SUBMITTING SCORE';
                        statusMessage.style.color = '#ff0000';
                        
                        // Re-enable button if submission failed
                        setTimeout(() => {
                            this.disabled = false;
                            this.textContent = 'TRY AGAIN';
                            
                            // Start countdown even if submission failed
                            doCountdownAndRestart();
                        }, 2000);
                    }
                };
                
                userProfile.appendChild(submitButton);
                
                window.safeLog("Submit score listener attached", "success");
            } catch (error) {
                window.safeLog(`Error in attachSubmitScoreListener: ${error.message}`, "error");
            }
        }
        
        // Function to show countdown and restart the game
        function doCountdownAndRestart() {
            try {
                window.safeLog("Starting countdown sequence", "info");
                
                // Create countdown element
                const countdownElement = document.createElement('div');
                countdownElement.className = 'countdown';
                document.body.appendChild(countdownElement);
                
                // Hide the game over overlay
                const overlay = document.getElementById('gameOverOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
                
                // Start countdown sequence
                let count = 3;
                countdownElement.textContent = count;
                
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownElement.textContent = count;
                    } else if (count === 0) {
                        countdownElement.textContent = 'GO!';
                    } else {
                        // Clear the interval and remove the countdown element
                        clearInterval(countdownInterval);
                        document.body.removeChild(countdownElement);
                        
                        // Reset the game
                        init();
                    }
                }, 1000);
                
                window.safeLog("Countdown sequence initiated", "success");
            } catch (error) {
                window.safeLog(`Error in countdown sequence: ${error.message}`, "error");
                // Fallback to direct reset if countdown fails
                init();
            }
        }
        
        // Event listeners
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') keys.left = true;
            if (e.key === 'ArrowRight') keys.right = true;
            if (e.key === ' ') keys.space = true;
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') keys.left = false;
            if (e.key === 'ArrowRight') keys.right = false;
            if (e.key === ' ') keys.space = false;
        });
        
        // Settings button functionality
        const settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) {
            settingsBtn.addEventListener('click', () => {
                const settingsOverlay = document.getElementById('settingsOverlay');
                if (settingsOverlay) {
                    settingsOverlay.style.display = 'flex';
                }
            });
        }
        
        // Close settings button functionality
        const closeSettings = document.getElementById('closeSettings');
        if (closeSettings) {
            closeSettings.addEventListener('click', () => {
                const settingsOverlay = document.getElementById('settingsOverlay');
                if (settingsOverlay) {
                    settingsOverlay.style.display = 'none';
                }
            });
        }
        
        // Start the game
        setTimeout(() => {
            console.log("Starting game...");
            init();
        }, 500);

        // Function to fetch high scores from Firebase
        function fetchHighScores() {
            try {
                if (!firebase || !firebase.database) {
                    window.safeLog("Firebase not available for fetching scores", "warning");
                    return;
                }
                
                window.safeLog("Fetching high scores from Firebase...", "info");
                const highscoresRef = firebase.database().ref('highscores');
                
                highscoresRef.orderByChild('score')
                    .limitToLast(10)
                    .once('value')
                    .then((snapshot) => {
                        const highscores = [];
                        snapshot.forEach((childSnapshot) => {
                            highscores.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // Sort by score in descending order
                        highscores.sort((a, b) => b.score - a.score);
                        
                        // Display the high scores
                        displayHighScores(highscores);
                        window.safeLog("High scores fetched successfully", "success");
                    })
                    .catch((error) => {
                        window.safeLog("Error fetching high scores: " + error.message, "error");
                    });
            } catch (error) {
                window.safeLog("Error in fetchHighScores: " + error.message, "error");
            }
        }

        // Function to display high scores
        function displayHighScores(highscores) {
            try {
                const highscoresList = document.getElementById('publicHighscoresList');
                if (!highscoresList) {
                    // Create the highscores container if it doesn't exist
                    createHighscoresDisplay();
                    return;
                }
                
                // Clear existing scores
                highscoresList.innerHTML = '';
                
                // Add header
                const header = document.createElement('div');
                header.className = 'highscore-header';
                header.innerHTML = '<span class="rank">RANK</span><span class="name">NAME</span><span class="score">SCORE</span>';
                highscoresList.appendChild(header);
                
                // Add each score
                if (highscores.length === 0) {
                    const noScores = document.createElement('div');
                    noScores.className = 'no-scores';
                    noScores.textContent = 'NO SCORES YET';
                    highscoresList.appendChild(noScores);
                } else {
                    highscores.forEach((score, index) => {
                        const scoreItem = document.createElement('div');
                        scoreItem.className = 'highscore-item';
                        
                        const rank = document.createElement('span');
                        rank.className = 'rank';
                        rank.textContent = (index + 1) + '.';
                        
                        const name = document.createElement('span');
                        name.className = 'name';
                        name.textContent = score.name || 'Anonymous';
                        
                        const scoreValue = document.createElement('span');
                        scoreValue.className = 'score';
                        scoreValue.textContent = score.score;
                        
                        scoreItem.appendChild(rank);
                        scoreItem.appendChild(name);
                        scoreItem.appendChild(scoreValue);
                        
                        highscoresList.appendChild(scoreItem);
                    });
                }
            } catch (error) {
                window.safeLog("Error displaying high scores: " + error.message, "error");
            }
        }

        // Function to create the highscores display
        function createHighscoresDisplay() {
            try {
                // Check if the container already exists
                if (document.getElementById('highscoresContainer')) {
                    return;
                }
                
                // Create container
                const container = document.createElement('div');
                container.id = 'highscoresContainer';
                container.className = 'highscores-container';
                
                // Style the container
                container.style.position = 'absolute';
                container.style.right = '10px';
                container.style.top = '10px';
                container.style.width = '300px';
                container.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                container.style.border = '2px solid #00ff00';
                container.style.padding = '10px';
                container.style.color = '#00ff00';
                container.style.fontFamily = '"Press Start 2P", monospace';
                container.style.fontSize = '10px';
                container.style.zIndex = '100';
                container.style.boxShadow = '0 0 10px #00ff00';
                container.style.textShadow = '0 0 5px #00ff00';
                
                // Create title
                const title = document.createElement('h3');
                title.textContent = 'HIGH SCORES';
                title.style.textAlign = 'center';
                title.style.marginTop = '0';
                title.style.marginBottom = '10px';
                title.style.padding = '5px';
                title.style.borderBottom = '1px solid #00ff00';
                
                // Create scores list
                const scoresList = document.createElement('div');
                scoresList.id = 'publicHighscoresList';
                scoresList.style.maxHeight = '300px';
                scoresList.style.overflowY = 'auto';
                
                // Add elements to container
                container.appendChild(title);
                container.appendChild(scoresList);
                
                // Add container to document
                document.body.appendChild(container);
                
                // Add CSS for the highscores
                const style = document.createElement('style');
                style.textContent = `
                    .highscores-container::-webkit-scrollbar {
                        width: 5px;
                    }
                    .highscores-container::-webkit-scrollbar-track {
                        background: #000;
                    }
                    .highscores-container::-webkit-scrollbar-thumb {
                        background: #00ff00;
                    }
                    .highscore-header, .highscore-item {
                        display: flex;
                        justify-content: space-between;
                        padding: 5px 0;
                        border-bottom: 1px solid rgba(0, 255, 0, 0.3);
                    }
                    .highscore-header {
                        font-weight: bold;
                        border-bottom: 2px solid #00ff00;
                    }
                    .rank {
                        width: 15%;
                        text-align: center;
                    }
                    .name {
                        width: 60%;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        white-space: nowrap;
                    }
                    .score {
                        width: 25%;
                        text-align: right;
                    }
                    .no-scores {
                        text-align: center;
                        padding: 20px 0;
                        color: #ff0000;
                    }
                `;
                document.head.appendChild(style);
                
                // Now fetch the scores to populate
                fetchHighScores();
            } catch (error) {
                window.safeLog("Error creating highscores display: " + error.message, "error");
            }
        }

        // Function to get public highscores
        function getPublicHighscores() {
            try {
                window.safeLog("Fetching public highscores", "info");
                
                // Check if Firebase is available
                if (!window.firebase || !window.firebase.database) {
                    window.safeLog("Firebase not available for fetching public highscores", "warning");
                    updatePublicHighscoresDisplay([]);
                    return;
                }
                
                const highscoresRef = firebase.database().ref('highscores');
                
                // Get top 25 scores ordered by score (descending)
                highscoresRef.orderByChild('score')
                    .limitToLast(25)
                    .once('value')
                    .then((snapshot) => {
                        const highscores = [];
                        snapshot.forEach((childSnapshot) => {
                            highscores.push({
                                id: childSnapshot.key,
                                ...childSnapshot.val()
                            });
                        });
                        
                        // Sort by score in descending order
                        highscores.sort((a, b) => b.score - a.score);
                        
                        // Update the display
                        updatePublicHighscoresDisplay(highscores);
                        window.safeLog("Public highscores fetched successfully", "success");
                    })
                    .catch((error) => {
                        window.safeLog("Error fetching public highscores: " + error.message, "error");
                        updatePublicHighscoresDisplay([]);
                    });
            } catch (error) {
                window.safeLog("Error in getPublicHighscores: " + error.message, "error");
                updatePublicHighscoresDisplay([]);
            }
        }
        
        // Function to update the public highscores display
        function updatePublicHighscoresDisplay(highscores) {
            try {
                const publicHighscoresList = document.getElementById('publicHighscoresList');
                if (!publicHighscoresList) {
                    window.safeLog("Public highscores list element not found", "warning");
                    return;
                }
                
                // Remove loading message
                const loadingElement = document.getElementById('loadingScores');
                if (loadingElement) {
                    publicHighscoresList.removeChild(loadingElement);
                }
                
                // Clear existing scores (except the header)
                const header = publicHighscoresList.querySelector('div:first-child');
                publicHighscoresList.innerHTML = '';
                
                if (header) {
                    publicHighscoresList.appendChild(header);
                }
                
                // Add each score
                if (highscores.length === 0) {
                    const noScores = document.createElement('div');
                    noScores.style.textAlign = 'center';
                    noScores.style.padding = '20px 0';
                    noScores.style.color = '#ffff00';
                    noScores.textContent = 'NO SCORES YET';
                    publicHighscoresList.appendChild(noScores);
                } else {
                    highscores.forEach((score, index) => {
                        const scoreItem = document.createElement('div');
                        scoreItem.style.display = 'flex';
                        scoreItem.style.justifyContent = 'space-between';
                        scoreItem.style.padding = '5px 0';
                        scoreItem.style.borderBottom = '1px solid rgba(255, 255, 0, 0.3)';
                        scoreItem.style.fontSize = '12px';
                        
                        // Highlight the top 3 scores
                        if (index < 3) {
                            scoreItem.style.color = '#ffff00';
                            scoreItem.style.textShadow = '0 0 5px #ffff00';
                        }
                        
                        const rank = document.createElement('span');
                        rank.style.width = '20%';
                        rank.style.textAlign = 'center';
                        rank.textContent = (index + 1) + '.';
                        
                        const name = document.createElement('span');
                        name.style.width = '50%';
                        name.style.textAlign = 'left';
                        name.style.overflow = 'hidden';
                        name.style.textOverflow = 'ellipsis';
                        name.style.whiteSpace = 'nowrap';
                        name.textContent = score.name || 'Anonymous';
                        
                        const scoreValue = document.createElement('span');
                        scoreValue.style.width = '30%';
                        scoreValue.style.textAlign = 'right';
                        scoreValue.textContent = score.score;
                        
                        scoreItem.appendChild(rank);
                        scoreItem.appendChild(name);
                        scoreItem.appendChild(scoreValue);
                        
                        publicHighscoresList.appendChild(scoreItem);
                    });
                }
            } catch (error) {
                window.safeLog("Error updating public highscores display: " + error.message, "error");
            }
        }

        // Player shoots
        function playerShoot() {
            if (gameOver) return;
            
            // Create a new bullet
            bullets.push({
                x: player.x + player.width / 2 - 2,
                y: player.y - 10,
                width: 4,
                height: 10,
                speed: BULLET_SPEED
            });
            
            // Play shoot sound
            playSoundEffect('shoot');
        }
        
        // Check for collisions
        function checkCollisions() {
            // Check bullet-enemy collisions
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    
                    if (
                        bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y
                    ) {
                        // Remove bullet and enemy
                        bullets.splice(i, 1);
                        enemies.splice(j, 1);
                        
                        // Increase score
                        score += 10;
                        
                        // Play explosion sound
                        playSoundEffect('explosion');
                        
                        // Add explosion effect
                        addExplosion(enemy.x + enemy.width / 2, enemy.y + enemy.height / 2);
                        
                        break;
                    }
                }
            }
            
            // Check enemy-player collisions
            for (let i = 0; i < enemies.length; i++) {
                const enemy = enemies[i];
                
                if (
                    player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y
                ) {
                    // Game over
                    endGame();
                    return;
                }
            }
        }
        
        // End the game
        function endGame() {
                gameOver = true;
            
            // Play game over sound
            playSoundEffect('gameOver');
            
            // Show game over screen
            showGameOverScreen();
        }

        // Add explosion effect
        function addExplosion(x, y) {
            explosions.push({
                x: x,
                y: y,
                radius: 5,
                maxRadius: 20,
                growthRate: 1.5,
                opacity: 1
            });
        }
        
        // Update explosions
        function updateExplosions() {
            for (let i = explosions.length - 1; i >= 0; i--) {
                const explosion = explosions[i];
                
                // Grow the explosion
                explosion.radius += explosion.growthRate;
                explosion.opacity -= 0.05;
                
                // Remove when fully expanded or faded
                if (explosion.radius >= explosion.maxRadius || explosion.opacity <= 0) {
                    explosions.splice(i, 1);
                }
            }
        }
        
        // Draw explosions
        function drawExplosions() {
            ctx.save();
            
            for (let i = 0; i < explosions.length; i++) {
                const explosion = explosions[i];
                
                // Create gradient
                const gradient = ctx.createRadialGradient(
                    explosion.x, explosion.y, 0,
                    explosion.x, explosion.y, explosion.radius
                );
                
                gradient.addColorStop(0, `rgba(255, 255, 0, ${explosion.opacity})`);
                gradient.addColorStop(0.5, `rgba(255, 128, 0, ${explosion.opacity})`);
                gradient.addColorStop(1, `rgba(255, 0, 0, ${explosion.opacity * 0.5})`);
                
                // Draw explosion
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // Add glow effect
                ctx.shadowColor = '#ff0';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(explosion.x, explosion.y, explosion.radius * 0.7, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 0, ${explosion.opacity * 0.5})`;
                ctx.fill();
            }
            
            ctx.restore();
        }

        // Settings button click handler
        document.getElementById('settingsBtn').addEventListener('click', function() {
            // Show settings overlay
            document.getElementById('settingsOverlay').style.display = 'block';
            
            // Update player name display
            const playerNameDisplay = document.getElementById('playerNameDisplay');
            const storedName = localStorage.getItem('playerName') || 'ANONYMOUS';
            playerNameDisplay.textContent = `PLAYER: ${storedName}`;
            
            // Update sound toggle
            const soundToggle = document.getElementById('soundToggle');
            if (soundToggle) {
                soundToggle.checked = !isMuted;
                
                // Add change handler if not already added
                if (!soundToggle.hasChangeListener) {
                    soundToggle.addEventListener('change', function() {
                        // Update only sound effects
                        for (const sound of Object.values(soundEffects)) {
                            sound.muted = !this.checked;
                        }
                        window.safeLog(`Sound effects ${this.checked ? 'enabled' : 'disabled'}`, "info");
                    });
                    soundToggle.hasChangeListener = true;
                }
            }
            
            // Update music toggle
            const musicToggle = document.getElementById('musicToggle');
            if (musicToggle) {
                musicToggle.checked = backgroundMusic ? !backgroundMusic.paused : !isMuted;
                
                // Add change handler if not already added
                if (!musicToggle.hasChangeListener) {
                    musicToggle.addEventListener('change', function() {
                        if (backgroundMusic) {
                            if (this.checked) {
                                playBackgroundMusic();
                            } else {
                                backgroundMusic.pause();
                            }
                        }
                        window.safeLog(`Music ${this.checked ? 'enabled' : 'disabled'}`, "info");
                    });
                    musicToggle.hasChangeListener = true;
                }
            }
        });
        
        // Close settings button click handler
        document.getElementById('closeSettings').addEventListener('click', function() {
            // Hide settings overlay
            document.getElementById('settingsOverlay').style.display = 'none';
        });
    </script>
</body>
</html>
